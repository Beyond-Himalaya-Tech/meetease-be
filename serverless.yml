# service: meetease-be

# frameworkVersion: '3'
# useDotenv: true

# provider:
#   name: aws
#   runtime: nodejs20.x
#   region: ${opt:region, 'ap-southeast-2'}
#   stage: ${opt:stage, 'dev'}
#   memorySize: 512
#   timeout: 30
#   environment:
#     DATABASE_URL: ${env:DATABASE_URL}
#     JWT_SECRET: ${env:JWT_SECRET}
#     CLIENT_ID: ${env:CLIENT_ID}
#     CLIENT_SECRET: ${env:CLIENT_SECRET}
#     REDIRECT_URL: ${env:REDIRECT_URL}
#     FRONTEND_URL: ${env:FRONTEND_URL}
#     SMTP_HOST: ${env:SMTP_HOST}
#     SMTP_PORT: ${env:SMTP_PORT}
#     SMTP_USER: ${env:SMTP_USER}
#     SMTP_PASS: ${env:SMTP_PASS}
#     SMTP_FROM: ${env:SMTP_FROM}
#     SMTP_FROM_NAME: ${env:SMTP_FROM_NAME}
#   iam:
#     role:
#       statements:
#         - Effect: Allow
#           Action:
#             - logs:CreateLogGroup
#             - logs:CreateLogStream
#             - logs:PutLogEvents
#           Resource: '*'

# functions:
#   api:
#     handler: src/lambda.handler
#     events:
#       - http:
#           path: /{proxy+}
#           method: ANY
#           cors:
#             origin: '*'
#             headers:
#               - Content-Type
#               - X-Amz-Date
#               - Authorization
#               - X-Api-Key
#               - X-Amz-Security-Token
#             allowCredentials: true
#       - http:
#           path: /
#           method: ANY
#           cors:
#             origin: '*'
#             headers:
#               - Content-Type
#               - X-Amz-Date
#               - Authorization
#               - X-Api-Key
#               - X-Amz-Security-Token
#             allowCredentials: true

# plugins:
#   - serverless-dotenv-plugin
#   - serverless-esbuild
#   - serverless-offline

# custom:
#   serverless-offline:
#     httpPort: 3000
#     noPrependStageInUrl: true
#   esbuild:
#     bundle: true
#     minify: false
#     sourcemap: false
#     format: 'cjs'
#     exclude:
#       - '@prisma/adapter-pg'
#       - 'pg'
#       - 'pg-native'
#       - 'date-fns'
#       - 'date-fns-tz'
#       - '@nestjs/websockets'
#       - '@nestjs/microservices'
#       - 'class-transformer'
#       - '@css-inline'
#     target: 'node20'
#     platform: 'node'
#     concurrency: 10
#     packager: npm
#     keepNames: true
#     define:
#       'process.env.NODE_ENV': '"production"'
#     packagerOptions:
#       scripts: []
#     installExtraArgs: ['--production']
#     external:
#       - '@prisma/adapter-pg'
#       - 'pg'
#       - 'pg-native'
#       - 'date-fns'
#       - 'date-fns/*'
#       - 'date-fns-tz'
#       - '@nestjs/websockets'
#       - '@nestjs/websockets/*'
#       - '@nestjs/microservices'
#       - '@nestjs/microservices/*'
#       - 'class-transformer'
#       - 'class-transformer/*'
#       - '@css-inline'
#       - '@css-inline/*'

# package:
#   individually: false
#   patterns:
#     # Include package.json
#     - 'package.json'
#     # Include external dependencies (can't be bundled)
#     - 'node_modules/.prisma/**'
#     - 'node_modules/@prisma/client/**'
#     - 'node_modules/@prisma/adapter-pg/**'
#     - 'node_modules/pg/**'
#     - 'node_modules/pg-native/**'
#     - 'node_modules/date-fns/**'
#     - 'node_modules/date-fns-tz/**'
#     - 'node_modules/@nestjs/websockets/**'
#     - 'node_modules/@nestjs/microservices/**'
#     - 'node_modules/class-transformer/**'
#     - 'node_modules/@css-inline/**'
#     # Exclude source files
#     - '!src/**'
#     - '!test/**'
#     - '!*.md'
#     - '!*.yml'
#     - '!*.yaml'
#     - '!package-lock.json'
#     - '!*.ts'
#     - '!tsconfig*.json'
#     - '!eslint.config.*'
#     - '!prisma/migrations/**'
#     - '!prisma/schema.prisma'
#     - '!.git/**'
#     - '!.github/**'
#     - '!.env*'
#     - '!dev.env'
#     - '!scripts/**'
#     - '!.serverlessignore'
#     - '!.DS_Store'
#     - '!dist/**'
#     # Exclude all other node_modules (esbuild bundles them)
#     - '!node_modules/**'
#     # Re-include external dependencies
#     - 'node_modules/.prisma/**'
#     - 'node_modules/@prisma/client/**'
#     - 'node_modules/@prisma/adapter-pg/**'
#     - 'node_modules/pg/**'
#     - 'node_modules/pg-native/**'
#     - 'node_modules/date-fns/**'
#     - 'node_modules/date-fns-tz/**'
#     - 'node_modules/@nestjs/websockets/**'
#     - 'node_modules/@nestjs/microservices/**'
#     - 'node_modules/class-transformer/**'
#     - 'node_modules/@css-inline/**'




# service: meetease-be

# frameworkVersion: '3'
# useDotenv: true

# provider:
#   name: aws
#   runtime: nodejs20.x
#   region: ${opt:region, 'ap-southeast-2'}
#   stage: ${opt:stage, 'dev'}
#   memorySize: 512
#   timeout: 30
#   environment:
#     DATABASE_URL: ${env:DATABASE_URL}
#     JWT_SECRET: ${env:JWT_SECRET}
#     CLIENT_ID: ${env:CLIENT_ID}
#     CLIENT_SECRET: ${env:CLIENT_SECRET}
#     REDIRECT_URL: ${env:REDIRECT_URL}
#     FRONTEND_URL: ${env:FRONTEND_URL}
#     SMTP_HOST: ${env:SMTP_HOST}
#     SMTP_PORT: ${env:SMTP_PORT}
#     SMTP_USER: ${env:SMTP_USER}
#     SMTP_PASS: ${env:SMTP_PASS}
#     SMTP_FROM: ${env:SMTP_FROM}
#     SMTP_FROM_NAME: ${env:SMTP_FROM_NAME}

# functions:
#   api:
#     handler: src/lambda.handler
#     events:
#       - http:
#           path: /
#           method: ANY
#           cors: true
#       - http:
#           path: /{proxy+}
#           method: ANY
#           cors: true

# plugins:
#   - serverless-dotenv-plugin
#   - serverless-esbuild
#   - serverless-offline

# custom:
#   serverless-offline:
#     httpPort: 3000
#     noPrependStageInUrl: true

#   esbuild:
#     bundle: true
#     format: cjs
#     platform: node
#     target: node20
#     minify: false
#     sourcemap: false
#     keepNames: true

#     # ⬇️ VERY IMPORTANT
#     external:
#       # NestJS optional modules (not installed)
#       - '@nestjs/microservices'
#       - '@nestjs/microservices/*'
#       - '@nestjs/websockets'
#       - '@nestjs/websockets/*'

#       # class-transformer deep import
#       - 'class-transformer/storage'

#       # native binaries (esbuild cannot bundle .node)
#       - '@css-inline'
#       - '@css-inline/*'


service: meetease-be
frameworkVersion: '3'
useDotenv: true

provider:
  name: aws
  region: ${opt:region, 'ap-southeast-2'}
  stage: ${opt:stage, 'dev'}
  memorySize: 512
  timeout: 30
  ecr:
    images:
      appimage:
        uri: ${aws:accountId}.dkr.ecr.${aws:region}.amazonaws.com/${self:service}-${self:provider.stage}:latest
  iam:
    role:
      statements:
        - Effect: Allow
          Action:
            - logs:CreateLogGroup
            - logs:CreateLogStream
            - logs:PutLogEvents
          Resource: '*'
  environment:
    DATABASE_URL: ${env:DATABASE_URL}
    JWT_SECRET: ${env:JWT_SECRET}
    CLIENT_ID: ${env:CLIENT_ID}
    CLIENT_SECRET: ${env:CLIENT_SECRET}
    REDIRECT_URL: ${env:REDIRECT_URL}
    FRONTEND_URL: ${env:FRONTEND_URL}
    SMTP_HOST: ${env:SMTP_HOST}
    SMTP_PORT: ${env:SMTP_PORT}
    SMTP_USER: ${env:SMTP_USER}
    SMTP_PASS: ${env:SMTP_PASS}
    SMTP_FROM: ${env:SMTP_FROM}
    SMTP_FROM_NAME: ${env:SMTP_FROM_NAME}

functions:
  api:
    image:
      uri: ${self:provider.ecr.images.appimage.uri}
    events:
      - http:
          path: /{proxy+}
          method: ANY
      - http:
          path: /
          method: ANY

  sendWeeklyDigest:
    image:
      uri: ${self:provider.ecr.images.appimage.uri}
    timeout: 60
    memorySize: 512
    events:
      - schedule:
          # TESTING: Runs every 5 minutes
          # Format: cron(minute hour day month dayOfWeek)
          # '*/5 * * * *' = Every 5 minutes
          # '15 10 * * *' = Every day at 10:15 AM UTC (4 PM Nepal)
          # '0 9 ? * MON *' = Every Monday at 9 AM UTC (original - for production)
          rate: cron(*/5 * * * *)
          enabled: true
          description: TESTING - Send tech news digest every 5 minutes

plugins:
  - serverless-dotenv-plugin
  - serverless-offline

custom:
  serverless-offline:
    httpPort: 3000
    noPrependStageInUrl: true
